name: ICP and NPM Start Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  setup_and_run:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Clang
      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang
          clang --version

      # Download and install DFX CLI directly from the official source
      - name: Install DFX CLI
        run: |
          DFX_VERSION=0.13.1  # Specify the desired version of dfx
          
          # Install DFX using the official installation script
          sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)" <<<"yes"

          # Add dfx to the PATH for the current job
          echo "$HOME/bin" >> $GITHUB_PATH

      # Verify DFX installation
      - name: Verify DFX Installation
        run: |
          echo "PATH: $PATH"
          ls -la $HOME/bin
          dfx --version

      # Start DFX in the background with clean slate
      - name: Start DFX
        run: |
          dfx start --background --clean
          sleep 10  # Wait for DFX to initialize

      # Install npm dependencies
      - name: Install npm dependencies
        run: npm install

      # Run the application
      - name: Run NPM start
        run: npm start
